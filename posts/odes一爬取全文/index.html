<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-language content="en">
<meta name=color-scheme content="light dark">
<meta name=author content="无生">
<meta name=description content="项目想法    因为一直没有一个比较完整的项目，所以想参考变卦做一个小的project，展示一个内容有限但是比较有意思的东西，顺便学习实践一下前端技术，于是就选择了诗经。内容不多，一共也就305首。一共分成3个步骤吧，第一步找个网站抓一个比较完整的全文下来，整理好之后存放到数据库里，第二步写一个前端把内容展示出来，但是这边是前后端配合还是单独一个前端页面还没有想好。第三步是其他功能的加入，比如注音和释义，甚至其他的一些比如统计数据之类的功能。
时间安排上并没有计划，主要最近空闲时间比较多，又不想复习，于是才想做这么个项目。反正先把坑挖在这，什么时候能做完就只能随缘了。
postgres安装和配置    其实这一部并不一定需要，因为内容确实不多，直接做成静态页面效果也不错。主要是为了之后第三部可能会需要比较复杂的功能时提前准备。但是没想到这一部花了比较多的时间，最后也只是能用，并没有设置成一个正常的状态。
postgres安装    按照各类教程中的内容，只需要这一步就可以安装好数据库并且自动开启服务，端口5432。
sudo apt-get install postgresql 但是执行完之后，psql并没有连上数据库，服务器上也看不到postgres的进程。
略去中间大量的搜索和尝试的过程，在/usr/lib/postgresql/9.1/bin/目录里找到常用的命令，于是按照手动启动数据库的方式启动：
/usr/lib/postgresql/9.1/bin/postgres -D ~/data 这里提示我不能用root权限开启服务，恍然大悟，之前没有成功启动的原因可能就是因为我一直使用的root用户(使用的服务器虽然用了很长一段时间了，但是当时仅仅安装了一个wordpress就没有登上去过了。所以一直都是root用户。)但是它为什么没有任何提示呢？！于是得到一个教训，新服务器第一件事就是建立一个新的非root用户。建了一个新的用户saukymo之后，终于成功开启了服务。
之后的过程由于大量试错，现在不能准确回忆起来了，不过应该还是通过这个目录下的initdb和createdb成功建立了一个数据库odes。
在Mac中，可以通过brew安装，安装完成之后就可以使用psql了，之后也能安装psycopg2的python库了。
brew install postgresql 直接使用psql命令进入数据库，然后给用户设置密码：
\password saukymo Postgres允许远程连接    默认情况下，只允许本机连接数据库，如果需要远程连接到数据库，需要设置postgres允许远程连接。设置比较简单，首先修改data目录下的pg_hba.conf文件，加入一行
host all all 0.0.0.0/0 md5 这样就能允许所有的ip通过密码访问数据库了。
然后修改postgresl.conf文件，设置listen_addresses为任意即可，即：
listen_addresses = '*' 然后重启服务，我这里因为安装方式不太正确，命令为：
/usr/lib/postgresql/9.1/bin/pg_ctl -D ~/data restart 此时就能在其他机器上连接上数据库了，完整的psql命令为：
psql -U saukymo -h ▇▇.▇▇.▇▇.▇▇ -d odes -W 按照提示输入之前设置的密码即可。
安装psycopg2    这个库是python用来连接postgres数据库的，通过pip安装即可
pip install psycopg2 需要注意的是，这个库并不能兼容Pypy，如果需要和Pypy一起工作的话，需要安装psycopg2cffi，简单设置之后，就可以兼容了，而且原来的代码不需要变化。">
<meta name=keywords content="blog,developer,personal">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Odes（一）爬取全文">
<meta name=twitter:description content="项目想法    因为一直没有一个比较完整的项目，所以想参考变卦做一个小的project，展示一个内容有限但是比较有意思的东西，顺便学习实践一下前端技术，于是就选择了诗经。内容不多，一共也就305首。一共分成3个步骤吧，第一步找个网站抓一个比较完整的全文下来，整理好之后存放到数据库里，第二步写一个前端把内容展示出来，但是这边是前后端配合还是单独一个前端页面还没有想好。第三步是其他功能的加入，比如注音和释义，甚至其他的一些比如统计数据之类的功能。
时间安排上并没有计划，主要最近空闲时间比较多，又不想复习，于是才想做这么个项目。反正先把坑挖在这，什么时候能做完就只能随缘了。
postgres安装和配置    其实这一部并不一定需要，因为内容确实不多，直接做成静态页面效果也不错。主要是为了之后第三部可能会需要比较复杂的功能时提前准备。但是没想到这一部花了比较多的时间，最后也只是能用，并没有设置成一个正常的状态。
postgres安装    按照各类教程中的内容，只需要这一步就可以安装好数据库并且自动开启服务，端口5432。
sudo apt-get install postgresql 但是执行完之后，psql并没有连上数据库，服务器上也看不到postgres的进程。
略去中间大量的搜索和尝试的过程，在/usr/lib/postgresql/9.1/bin/目录里找到常用的命令，于是按照手动启动数据库的方式启动：
/usr/lib/postgresql/9.1/bin/postgres -D ~/data 这里提示我不能用root权限开启服务，恍然大悟，之前没有成功启动的原因可能就是因为我一直使用的root用户(使用的服务器虽然用了很长一段时间了，但是当时仅仅安装了一个wordpress就没有登上去过了。所以一直都是root用户。)但是它为什么没有任何提示呢？！于是得到一个教训，新服务器第一件事就是建立一个新的非root用户。建了一个新的用户saukymo之后，终于成功开启了服务。
之后的过程由于大量试错，现在不能准确回忆起来了，不过应该还是通过这个目录下的initdb和createdb成功建立了一个数据库odes。
在Mac中，可以通过brew安装，安装完成之后就可以使用psql了，之后也能安装psycopg2的python库了。
brew install postgresql 直接使用psql命令进入数据库，然后给用户设置密码：
\password saukymo Postgres允许远程连接    默认情况下，只允许本机连接数据库，如果需要远程连接到数据库，需要设置postgres允许远程连接。设置比较简单，首先修改data目录下的pg_hba.conf文件，加入一行
host all all 0.0.0.0/0 md5 这样就能允许所有的ip通过密码访问数据库了。
然后修改postgresl.conf文件，设置listen_addresses为任意即可，即：
listen_addresses = '*' 然后重启服务，我这里因为安装方式不太正确，命令为：
/usr/lib/postgresql/9.1/bin/pg_ctl -D ~/data restart 此时就能在其他机器上连接上数据库了，完整的psql命令为：
psql -U saukymo -h ▇▇.▇▇.▇▇.▇▇ -d odes -W 按照提示输入之前设置的密码即可。
安装psycopg2    这个库是python用来连接postgres数据库的，通过pip安装即可
pip install psycopg2 需要注意的是，这个库并不能兼容Pypy，如果需要和Pypy一起工作的话，需要安装psycopg2cffi，简单设置之后，就可以兼容了，而且原来的代码不需要变化。">
<meta property="og:title" content="Odes（一）爬取全文">
<meta property="og:description" content="项目想法    因为一直没有一个比较完整的项目，所以想参考变卦做一个小的project，展示一个内容有限但是比较有意思的东西，顺便学习实践一下前端技术，于是就选择了诗经。内容不多，一共也就305首。一共分成3个步骤吧，第一步找个网站抓一个比较完整的全文下来，整理好之后存放到数据库里，第二步写一个前端把内容展示出来，但是这边是前后端配合还是单独一个前端页面还没有想好。第三步是其他功能的加入，比如注音和释义，甚至其他的一些比如统计数据之类的功能。
时间安排上并没有计划，主要最近空闲时间比较多，又不想复习，于是才想做这么个项目。反正先把坑挖在这，什么时候能做完就只能随缘了。
postgres安装和配置    其实这一部并不一定需要，因为内容确实不多，直接做成静态页面效果也不错。主要是为了之后第三部可能会需要比较复杂的功能时提前准备。但是没想到这一部花了比较多的时间，最后也只是能用，并没有设置成一个正常的状态。
postgres安装    按照各类教程中的内容，只需要这一步就可以安装好数据库并且自动开启服务，端口5432。
sudo apt-get install postgresql 但是执行完之后，psql并没有连上数据库，服务器上也看不到postgres的进程。
略去中间大量的搜索和尝试的过程，在/usr/lib/postgresql/9.1/bin/目录里找到常用的命令，于是按照手动启动数据库的方式启动：
/usr/lib/postgresql/9.1/bin/postgres -D ~/data 这里提示我不能用root权限开启服务，恍然大悟，之前没有成功启动的原因可能就是因为我一直使用的root用户(使用的服务器虽然用了很长一段时间了，但是当时仅仅安装了一个wordpress就没有登上去过了。所以一直都是root用户。)但是它为什么没有任何提示呢？！于是得到一个教训，新服务器第一件事就是建立一个新的非root用户。建了一个新的用户saukymo之后，终于成功开启了服务。
之后的过程由于大量试错，现在不能准确回忆起来了，不过应该还是通过这个目录下的initdb和createdb成功建立了一个数据库odes。
在Mac中，可以通过brew安装，安装完成之后就可以使用psql了，之后也能安装psycopg2的python库了。
brew install postgresql 直接使用psql命令进入数据库，然后给用户设置密码：
\password saukymo Postgres允许远程连接    默认情况下，只允许本机连接数据库，如果需要远程连接到数据库，需要设置postgres允许远程连接。设置比较简单，首先修改data目录下的pg_hba.conf文件，加入一行
host all all 0.0.0.0/0 md5 这样就能允许所有的ip通过密码访问数据库了。
然后修改postgresl.conf文件，设置listen_addresses为任意即可，即：
listen_addresses = '*' 然后重启服务，我这里因为安装方式不太正确，命令为：
/usr/lib/postgresql/9.1/bin/pg_ctl -D ~/data restart 此时就能在其他机器上连接上数据库了，完整的psql命令为：
psql -U saukymo -h ▇▇.▇▇.▇▇.▇▇ -d odes -W 按照提示输入之前设置的密码即可。
安装psycopg2    这个库是python用来连接postgres数据库的，通过pip安装即可
pip install psycopg2 需要注意的是，这个库并不能兼容Pypy，如果需要和Pypy一起工作的话，需要安装psycopg2cffi，简单设置之后，就可以兼容了，而且原来的代码不需要变化。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.mkdef.com/posts/odes%E4%B8%80%E7%88%AC%E5%8F%96%E5%85%A8%E6%96%87/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2016-06-16T10:02:25+08:00">
<meta property="article:modified_time" content="2016-06-16T10:02:25+08:00">
<title>
Odes（一）爬取全文 · Coder
</title>
<link rel=canonical href=https://blog.mkdef.com/posts/odes%E4%B8%80%E7%88%AC%E5%8F%96%E5%85%A8%E6%96%87/>
<link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin>
<link rel=stylesheet href=/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen>
<link rel=stylesheet href=/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen>
<link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16>
<link rel=apple-touch-icon href=/images/apple-touch-icon.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png>
<meta name=generator content="Hugo 0.92.0">
</head>
<body class="preload-transitions colorscheme-auto">
<div class=float-container>
<a id=dark-mode-toggle class=colorscheme-toggle>
<i class="fa fa-adjust fa-fw" aria-hidden=true></i>
</a>
</div>
<main class=wrapper>
<nav class=navigation>
<section class=container>
<a class=navigation-title href=/>
Coder
</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle>
<i class="fa fa-bars fa-fw" aria-hidden=true></i>
</label>
<ul class=navigation-list>
<li class=navigation-item>
<a class=navigation-link href=/posts/>Blog</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/about/>About</a>
</li>
</ul>
</section>
</nav>
<div class=content>
<section class="container post">
<article>
<header>
<div class=post-title>
<h1 class=title>
<a class=title-link href=https://blog.mkdef.com/posts/odes%E4%B8%80%E7%88%AC%E5%8F%96%E5%85%A8%E6%96%87/>
Odes（一）爬取全文
</a>
</h1>
</div>
<div class=post-meta>
<div class=date>
<span class=posted-on>
<i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2016-06-16T10:02:25+08:00>
June 16, 2016
</time>
</span>
<span class=reading-time>
<i class="fa fa-clock-o" aria-hidden=true></i>
3-minute read
</span>
</div>
<div class=tags>
<i class="fa fa-tag" aria-hidden=true></i>
<span class=tag>
<a href=/tags/python/>Python</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/%E8%AF%97%E7%BB%8F/>诗经</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/%E7%88%AC%E8%99%AB/>爬虫</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/lxml/>lxml</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/postgresql/>postgresql</a>
</span></div>
</div>
</header>
<div>
<h2 id=项目想法>
项目想法
<a class=heading-link href=#%e9%a1%b9%e7%9b%ae%e6%83%b3%e6%b3%95>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>因为一直没有一个比较完整的项目，所以想参考<a href=http://zhangwenli.com/biangua/>变卦</a>做一个小的project，展示一个内容有限但是比较有意思的东西，顺便学习实践一下前端技术，于是就选择了诗经。内容不多，一共也就305首。一共分成3个步骤吧，第一步找个网站抓一个比较完整的全文下来，整理好之后存放到数据库里，第二步写一个前端把内容展示出来，但是这边是前后端配合还是单独一个前端页面还没有想好。第三步是其他功能的加入，比如注音和释义，甚至其他的一些比如统计数据之类的功能。</p>
<p>时间安排上并没有计划，主要最近空闲时间比较多，又不想复习，于是才想做这么个项目。反正先把坑挖在这，什么时候能做完就只能随缘了。</p>
<h2 id=postgres安装和配置>
postgres安装和配置
<a class=heading-link href=#postgres%e5%ae%89%e8%a3%85%e5%92%8c%e9%85%8d%e7%bd%ae>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>其实这一部并不一定需要，因为内容确实不多，直接做成静态页面效果也不错。主要是为了之后第三部可能会需要比较复杂的功能时提前准备。但是没想到这一部花了比较多的时间，最后也只是能用，并没有设置成一个正常的状态。</p>
<h3 id=postgres安装>
postgres安装
<a class=heading-link href=#postgres%e5%ae%89%e8%a3%85>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>按照各类教程中的内容，只需要这一步就可以安装好数据库并且自动开启服务，端口5432。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo apt-get install postgresql
</code></pre></div><p>但是执行完之后，psql并没有连上数据库，服务器上也看不到postgres的进程。</p>
<p>略去中间大量的搜索和尝试的过程，在<code>/usr/lib/postgresql/9.1/bin/</code>目录里找到常用的命令，于是按照手动启动数据库的方式启动：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>/usr/lib/postgresql/9.1/bin/postgres -D ~/data
</code></pre></div><p>这里提示我不能用root权限开启服务，恍然大悟，之前没有成功启动的原因可能就是因为我一直使用的root用户(使用的服务器虽然用了很长一段时间了，但是当时仅仅安装了一个wordpress就没有登上去过了。所以一直都是root用户。)但是它为什么没有任何提示呢？！于是得到一个教训，新服务器第一件事就是建立一个新的非root用户。建了一个新的用户<code>saukymo</code>之后，终于成功开启了服务。</p>
<p>之后的过程由于大量试错，现在不能准确回忆起来了，不过应该还是通过这个目录下的<code>initdb</code>和<code>createdb</code>成功建立了一个数据库<code>odes</code>。</p>
<p>在Mac中，可以通过<code>brew</code>安装，安装完成之后就可以使用<code>psql</code>了，之后也能安装<code>psycopg2</code>的python库了。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>brew install postgresql
</code></pre></div><p>直接使用<code>psql</code>命令进入数据库，然后给用户设置密码：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=font-weight:700;font-style:italic>\p</span>assword saukymo
</code></pre></div><h3 id=postgres允许远程连接>
Postgres允许远程连接
<a class=heading-link href=#postgres%e5%85%81%e8%ae%b8%e8%bf%9c%e7%a8%8b%e8%bf%9e%e6%8e%a5>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>默认情况下，只允许本机连接数据库，如果需要远程连接到数据库，需要设置postgres允许远程连接。设置比较简单，首先修改<code>data</code>目录下的<code>pg_hba.conf</code>文件，加入一行</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>host    all             all             0.0.0.0/0               md5
</code></pre></div><p>这样就能允许所有的ip通过密码访问数据库了。</p>
<p>然后修改<code>postgresl.conf</code>文件，设置<code>listen_addresses</code>为任意即可，即：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>listen_addresses = &#39;*&#39;
</code></pre></div><p>然后重启服务，我这里因为安装方式不太正确，命令为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>/usr/lib/postgresql/9.1/bin/pg_ctl -D ~/data restart
</code></pre></div><p>此时就能在其他机器上连接上数据库了，完整的<code>psql</code>命令为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>psql -U saukymo -h ▇▇.▇▇.▇▇.▇▇ -d odes -W
</code></pre></div><p>按照提示输入之前设置的密码即可。</p>
<h3 id=安装psycopg2>
安装psycopg2
<a class=heading-link href=#%e5%ae%89%e8%a3%85psycopg2>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>这个库是python用来连接<code>postgres</code>数据库的，通过<code>pip</code>安装即可</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>pip install psycopg2
</code></pre></div><p>需要注意的是，这个库并不能兼容<code>Pypy</code>，如果需要和<code>Pypy</code>一起工作的话，需要安装<a href=https://pypi.python.org/pypi/psycopg2cffi>psycopg2cffi</a>，简单设置之后，就可以兼容了，而且原来的代码不需要变化。</p>
<p>可以用以下代码进行测试：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=font-style:italic>#coding: utf-8</span>
<span style=font-weight:700>import</span> <span style=font-weight:700>psycopg2</span> <span style=font-weight:700>as</span> <span style=font-weight:700>pg</span>

<span style=font-weight:700>if</span> __name__ == <span style=font-style:italic>&#39;__main__&#39;</span>:
    db = pg.connect(database=<span style=font-style:italic>&#34;odes&#34;</span>, user=<span style=font-style:italic>&#34;saukymo&#34;</span>, password=<span style=font-style:italic>&#34;▇▇▇▇▇▇▇▇&#34;</span>, host=<span style=font-style:italic>&#34;▇▇.▇▇.▇▇.▇▇&#34;</span>, port=<span style=font-style:italic>&#34;5432&#34;</span>) 
</code></pre></div><h2 id=爬取诗经全文>
爬取诗经全文
<a class=heading-link href=#%e7%88%ac%e5%8f%96%e8%af%97%e7%bb%8f%e5%85%a8%e6%96%87>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>需要的库比较少，除了<code>psycopg2</code>，另外就是<code>lxml</code>用来解析HTML，其他的库暂时都不需要了。安装方法都是通过<code>pip</code>。</p>
<p>目标网页一开始选择的是<a href=http://www.shigeku.com/xlib/gd/sj305/>诗歌库</a>，因为发现结构挺简单的，好像也比较完整和规范。所以还比较顺利地抓完了目录和第一篇正文，但是开始全文抓取的时候，第二篇就编码错误了。本来也没多想，编码错误再正常不过了，于是尝试了多个不同的中文编码，全部报错，<code>ISO</code>虽然能解析完，但是解析出来的都是看不懂的蚂蚁文。</p>
<p>看了一下网页编码，<code>GB2312</code>，应该没有问题呀，但是解析不对。安装了<code>chardet</code>探测，发现出错的页面里，虽然主要是&rsquo;gb2312'，但是置信度确实不高，反复检查之后发现，原来是原文中本来就存在解析不了乱码，显示成了方框。</p>
<p>思考了一番，没有什么好的方法，只好换抓另一个网页：<a href="http://www.zwbk.org/MyLemmaShow.aspx?lid=76385">中文百科在线</a>，简单看了一下，还不错，目录简单，结构还比较规范，于是就开始抓了，结果发现所谓的规范，仅仅是看上去而已。</p>
<h3 id=爬取目录>
爬取目录
<a class=heading-link href=#%e7%88%ac%e5%8f%96%e7%9b%ae%e5%bd%95>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>目录爬取比较简单，全部代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>url = <span style=font-style:italic>&#34;http://www.zwbk.org/MyLemmaShow.aspx?lid=76385&#34;</span>
connect = urlopen(url)

content = connect.read()
page = html.parse(StringIO(content.decode(<span style=font-style:italic>&#39;utf-8&#39;</span>)))
table = page.xpath(<span style=font-style:italic>&#34;//table/tr/td[2]/div/div[7]&#34;</span>)

collect_list = []
<span style=font-weight:700>for</span> links <span style=font-weight:700>in</span> table[0].find_class(<span style=font-style:italic>&#34;classic&#34;</span>):
	title = links.text_content().split(<span style=font-style:italic>u</span><span style=font-style:italic>&#34;·&#34;</span>)
	<span style=font-weight:700>if</span> len(title) &gt; 3:
		page_url = links.attrib.get(<span style=font-style:italic>&#34;href&#34;</span>)
		collect_list.append({
			<span style=font-style:italic>&#34;category&#34;</span>: title[1],
			<span style=font-style:italic>&#34;collect&#34;</span>: title[2],
			<span style=font-style:italic>&#34;title&#34;</span>: title[3],
			<span style=font-style:italic>&#34;page_url&#34;</span>: page_url
			})
</code></pre></div><p>因为网站给这些目录全部加上了<code>classic</code>类，所以先用<code>xpath</code>找到具体的代码块，然后在其中找<code>classic</code>类即可。</p>
<p>然后通过map来批量抓取全部正文：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>result = map(<span style=font-weight:700>lambda</span> x: get_fulltext(**x), collect_list)
</code></pre></div><h3 id=爬取正文>
爬取正文
<a class=heading-link href=#%e7%88%ac%e5%8f%96%e6%ad%a3%e6%96%87>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>正文部分就比较麻烦了，首先内容不是被单独封装在一起的，而是被各种<code>h2</code>,<code>br</code>等标签分隔开了，所以提取比较麻烦，正好同学之前问了相同的问题，当时没有给出好的解决方法，这次搜索了一下发现，<code>lxml</code>提供了<code>tail</code>方法，可以得到两个子元素之间的内容，于是比较好的解决了这个问题。代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=font-weight:700>def</span> get_fulltext(category, collect, title, page_url):
	print category, collect, title
	<span style=font-weight:700>try</span>:
		content = urlopen(page_url).read()
	<span style=font-weight:700>except</span> <span style=font-weight:700>Exception</span> <span style=font-weight:700>as</span> e:
		print e
		<span style=font-weight:700>return</span> {<span style=font-style:italic>&#34;title&#34;</span>:<span style=font-style:italic>&#34;</span><span style=font-weight:700;font-style:italic>%s</span><span style=font-style:italic>_</span><span style=font-weight:700;font-style:italic>%s</span><span style=font-style:italic>_</span><span style=font-weight:700;font-style:italic>%s</span><span style=font-style:italic>&#34;</span> % (category, collect, title), <span style=font-style:italic>&#34;text&#34;</span>:<span style=font-style:italic>&#34;&#34;</span>}
		
	page = html.parse(StringIO(content.decode(<span style=font-style:italic>&#39;utf-8&#39;</span>)))
	table = page.xpath(<span style=font-style:italic>&#39;//td[2]/div/div[7]&#39;</span>)
	<span style=font-weight:700>if</span> len(table) &gt; 0:
		odes = table[0]
		skip_state = 0
		full_text = []
		<span style=font-weight:700>for</span> element <span style=font-weight:700>in</span> odes.getchildren():
			text = <span style=font-style:italic>&#34;&#34;</span>
			<span style=font-weight:700>if</span> element.tag <span style=font-weight:700>is</span> etree.Comment:
				<span style=font-weight:700>continue</span>
			<span style=font-weight:700>if</span> element.tag == <span style=font-style:italic>&#34;h2&#34;</span>:
				skip_state += 1
			<span style=font-weight:700>if</span> (element.tag == <span style=font-style:italic>&#34;div&#34;</span>) <span style=font-weight:700>and</span> skip_state == 1:
				text = element.text_content().strip()
			<span style=font-weight:700>if</span> (element.tag == <span style=font-style:italic>&#34;br&#34;</span>) <span style=font-weight:700>and</span> skip_state == 1:
				<span style=font-weight:700>if</span> element.tail <span style=font-weight:700>is</span> <span style=font-weight:700>not</span> <span style=font-weight:700>None</span>:
					text = element.tail.strip()
			<span style=font-weight:700>if</span> text != <span style=font-style:italic>&#34;&#34;</span>:
				full_text.append(text)
	<span style=font-weight:700>return</span> {<span style=font-style:italic>&#34;title&#34;</span>:<span style=font-style:italic>&#34;</span><span style=font-weight:700;font-style:italic>%s</span><span style=font-style:italic>_</span><span style=font-weight:700;font-style:italic>%s</span><span style=font-style:italic>_</span><span style=font-weight:700;font-style:italic>%s</span><span style=font-style:italic>&#34;</span> % (category, collect, title), <span style=font-style:italic>&#34;text&#34;</span>:full_text}
</code></pre></div><p>大意是提取第一个<code>h2</code>和第二个<code>h2</code>之间的所有内容。比较顺利的得到了大部分正文。有如下几个问题和我采用的解决方法(好像全都是手动完善的&mldr;)</p>
<pre><code>1. 鹊巢这一篇抓不到正文内容，原因不详，不过只有这一篇，所以手工补全；
2. 有的正文混入了注释，手工删除；	
3. 抓一部分之后，会出现连续的503错误，猜测网站做了防抓取或者平时访问没有这么频繁，短时间内挂掉了。多抓几次，手工拼合。
4. 这个网站，颂部分少了很多篇，比如清庙之什应该是10篇的，它只有一篇，所以手工从诗歌库上复制粘贴过来，然后替换成相同格式。
5. 有的篇章没有换行，或者有多余空格，手工清除。
6. 保存的文本用python读取不出来，原因不详。用`Sublime Text`打开，复制粘贴到新的文件，一切正常。
</code></pre>
<p>秉承的唯一信念就是，反正只有300篇，也是一次性的工作，做完就可以了。所以手工修复了所有的bug，目前看上去效果良好。</p>
<h2 id=上传数据库>
上传数据库
<a class=heading-link href=#%e4%b8%8a%e4%bc%a0%e6%95%b0%e6%8d%ae%e5%ba%93>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<h3 id=建表>
建表
<a class=heading-link href=#%e5%bb%ba%e8%a1%a8>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>一共就一个表，代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql>	<span style=font-weight:700>CREATE</span> <span style=font-weight:700>TABLE</span> <span style=font-weight:700>IF</span> <span style=font-weight:700>NOT</span> <span style=font-weight:700>EXISTS</span> odes (
        id SERIAL <span style=font-weight:700>PRIMARY</span> <span style=font-weight:700>KEY</span>,
        p_class <span>TEXT</span>,
        p_group <span>TEXT</span>,
        p_subgroup <span>TEXT</span>,
        title <span>TEXT</span>,
        full_text <span>TEXT</span>,
        create_time <span>TIMESTAMP</span>,
        update_time <span>TIMESTAMP</span> 
</code></pre></div><p>其中，<code>p_class</code>是指风雅颂三类，<code>p_group</code>是细分，比如<code>周南</code>,<code>召南</code>。<code>p_subgroup</code>指的是什。其他看名字就知道了。
另外 <code>SERIAL</code>是自增序列，<code>postgres</code>会自动新建一个自增的序列作为它的值。当然也可以手工建立，然后链接过来。</p>
<h3 id=设置触发器>
设置触发器
<a class=heading-link href=#%e8%ae%be%e7%bd%ae%e8%a7%a6%e5%8f%91%e5%99%a8>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>然后为创建和更新时间设置触发器自动更新。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql>	<span style=font-weight:700>CREATE</span> <span style=font-weight:700>OR</span> <span style=font-weight:700>REPLACE</span> FUNCTION auto_timestamp() RETURNS <span style=font-weight:700>trigger</span> <span style=font-weight:700>AS</span> <span>$</span>auto_timestamp<span>$</span>
        BEGIN
        <span style=font-weight:700>IF</span> (TG_OP = <span style=font-style:italic>&#39;INSERT&#39;</span>) <span style=font-weight:700>THEN</span>
                NEW.create_time := <span style=font-weight:700>current_timestamp</span>;
           NEW.update_time := <span style=font-weight:700>current_timestamp</span>;
        ELSIF (TG_OP = <span style=font-style:italic>&#39;UPDATE&#39;</span>) <span style=font-weight:700>THEN</span>
          NEW.update_time := <span style=font-weight:700>current_timestamp</span>;
        END <span style=font-weight:700>IF</span>;
            <span style=font-weight:700>RETURN</span> NEW;
        END;
        <span>$</span>auto_timestamp<span>$</span> LANGUAGE plpgsql;

    <span style=font-weight:700>DROP</span> <span style=font-weight:700>TRIGGER</span> <span style=font-weight:700>IF</span> <span style=font-weight:700>EXISTS</span> auto_timestamp <span style=font-weight:700>ON</span> odes;
    <span style=font-weight:700>CREATE</span> <span style=font-weight:700>TRIGGER</span> auto_timestamp <span style=font-weight:700>BEFORE</span> <span style=font-weight:700>INSERT</span> <span style=font-weight:700>OR</span> <span style=font-weight:700>UPDATE</span> <span style=font-weight:700>ON</span> odes
        <span style=font-weight:700>FOR</span> <span style=font-weight:700>EACH</span> ROW EXECUTE <span style=font-weight:700>PROCEDURE</span> auto_timestamp();
</code></pre></div><h3 id=上传>
上传
<a class=heading-link href=#%e4%b8%8a%e4%bc%a0>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>具体解析就不写了，因为保存的格式是我自定义的。上传部分的代码如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=font-weight:700>def</span> upload_one_ode(metadata):
    script = <span style=font-style:italic>&#34;&#34;&#34;
</span><span style=font-style:italic>        INSERT INTO odes (p_class, p_group, p_subgroup, title, full_text) 
</span><span style=font-style:italic>            VALUES (</span><span style=font-weight:700;font-style:italic>%(p_class)s</span><span style=font-style:italic>, </span><span style=font-weight:700;font-style:italic>%(p_group)s</span><span style=font-style:italic>, </span><span style=font-weight:700;font-style:italic>%(p_subgroup)s</span><span style=font-style:italic>, </span><span style=font-weight:700;font-style:italic>%(title)s</span><span style=font-style:italic>, </span><span style=font-weight:700;font-style:italic>%(full_text)s</span><span style=font-style:italic>);
</span><span style=font-style:italic>    &#34;&#34;&#34;</span>
    cu.execute(script, metadata)
</code></pre></div><p>最后记得<code>commit</code>就行。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>db.commit()
</code></pre></div><h3 id=在数据库中查看数据>
在数据库中查看数据
<a class=heading-link href=#%e5%9c%a8%e6%95%b0%e6%8d%ae%e5%ba%93%e4%b8%ad%e6%9f%a5%e7%9c%8b%e6%95%b0%e6%8d%ae>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h3>
<p>首先，连接到数据库中，看一下有多少条记录。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>odes=# select count(*) from odes;
 count
-------
   305
(1 row)
</code></pre></div><p>然后随便抽一条数据检查一下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>odes=# select * from odes where id=180;
 id  | p_class | p_group | p_subgroup | title |                          full_text                           |        create_time         |        update_time
-----+---------+---------+------------+-------+--------------------------------------------------------------+----------------------------+----------------------------
 180 | 雅      | 小雅     | 彤弓之什    | 吉日   | 吉日维戊，既伯既祷。田车既好，四牡孔阜。升彼大阜，从其群丑。+| 2016-06-15 21:53:41.366594 | 2016-06-15 21:53:41.366594
     |         |         |            |       | 吉日庚午，既差我马。兽之所同，麀鹿麌麌。漆沮之从，天子之所。+|                            |
     |         |         |            |       | 瞻彼中原，其祁孔有。儦儦俟俟，或群或友。悉率左右，以燕天子。+|                            |
     |         |         |            |       | 既张我弓，既挟我矢。发彼小豝，殪此大兕。以御宾客，且以酌醴。+|                            |
     |         |         |            |       |                                                              |                            |
(1 row)
</code></pre></div><p>其中<code>+</code>应该是换行符，可以看到还是比较规整的。</p>
<h2 id=小结>
小结
<a class=heading-link href=#%e5%b0%8f%e7%bb%93>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>本来是一个非常简单的任务，还是花了不少时间和精力，而且过程中很多问题都只是绕了过去，并没有真正解决。不过好在最后的结果还是很不错的。目前还有一个问题值得商榷，就是保存正文时，换行是我手工换的，之后显示出来不一定好看，所以是否可以考虑不保存换行符，之后动态的调整。不过这个问题之后还是修改的空间，可以之后再根据情况调整。</p>
<p>全文可以在<a href=https://github.com/saukymo/odes/blob/master/crawler/full_text.txt>这里</a>下载到</p>
</div>
<footer>
</footer>
</article>
</section>
</div>
<footer class=footer>
<section class=container>
©
2016 -
2022
无生
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.
</section>
</footer>
</main>
<script src=/js/coder.min.39a51230dce2ac866c049b52573e38bf60666af4bc63c1bdf203b9b2d95b1cd6.js integrity="sha256-OaUSMNzirIZsBJtSVz44v2BmavS8Y8G98gO5stlbHNY="></script>
</body>
</html>