<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-language content="en">
<meta name=color-scheme content="light dark">
<meta name=author content="无生">
<meta name=description content="本文主要是记录一下最近在两个小项目odes和kraken中使用的持续集成技术。
所使用的基础组件    代码托管在Github上，使用github集成的Travis CI自动触发CI流程。在CI中自动build新的image上传到Docker Hub。然后通过sshpass远程登录server触发部署脚本。部署脚本pull新的image然后部署。
Dockerfile    由于项目都是基于python的，所以dockerfile比较简单：
FROMubuntu:latestMAINTAINERShaobo Liu <shaobo@mkdef.com>LABEL Description=&#34;This image is used to flask-kraken&#34;RUN apt-get update -yRUN apt-get install -y python3-pip python3-dev build-essentialCOPY src /appCOPY requirements.txt /appWORKDIR/appRUN pip3 install -r requirements.txtENTRYPOINT [&#34;python3&#34;]CMD [&#34;app.py&#34;]分解一下：
FROMubuntu:latestMAINTAINERShaobo Liu <shaobo@mkdef.com>LABEL Description=&#34;This image is used to flask-kraken&#34;首先申明使用的基础镜像，然后写上大名表示我是维护这个镜像的作者和这个镜像的用途。
RUN apt-get update -yRUN apt-get install -y python3-pip python3-dev build-essential安装python3，如果有其他的工具或者lib，也要写在这里。
COPY src /appCOPY requirements.txt /appWORKDIR/appRUN pip3 install -r requirements.txt复制源代码到docker里，然后切换工作目录，安装三方依赖。 有时候这里需要安装一些系统级的依赖，比如lxml或者psycopg2之类的，就需要加到前面apt-get install里去。">
<meta name=keywords content="blog,developer,personal">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="基于travis和docker的持续集成">
<meta name=twitter:description content="本文主要是记录一下最近在两个小项目odes和kraken中使用的持续集成技术。
所使用的基础组件    代码托管在Github上，使用github集成的Travis CI自动触发CI流程。在CI中自动build新的image上传到Docker Hub。然后通过sshpass远程登录server触发部署脚本。部署脚本pull新的image然后部署。
Dockerfile    由于项目都是基于python的，所以dockerfile比较简单：
FROMubuntu:latestMAINTAINERShaobo Liu <shaobo@mkdef.com>LABEL Description=&#34;This image is used to flask-kraken&#34;RUN apt-get update -yRUN apt-get install -y python3-pip python3-dev build-essentialCOPY src /appCOPY requirements.txt /appWORKDIR/appRUN pip3 install -r requirements.txtENTRYPOINT [&#34;python3&#34;]CMD [&#34;app.py&#34;]分解一下：
FROMubuntu:latestMAINTAINERShaobo Liu <shaobo@mkdef.com>LABEL Description=&#34;This image is used to flask-kraken&#34;首先申明使用的基础镜像，然后写上大名表示我是维护这个镜像的作者和这个镜像的用途。
RUN apt-get update -yRUN apt-get install -y python3-pip python3-dev build-essential安装python3，如果有其他的工具或者lib，也要写在这里。
COPY src /appCOPY requirements.txt /appWORKDIR/appRUN pip3 install -r requirements.txt复制源代码到docker里，然后切换工作目录，安装三方依赖。 有时候这里需要安装一些系统级的依赖，比如lxml或者psycopg2之类的，就需要加到前面apt-get install里去。">
<meta property="og:title" content="基于travis和docker的持续集成">
<meta property="og:description" content="本文主要是记录一下最近在两个小项目odes和kraken中使用的持续集成技术。
所使用的基础组件    代码托管在Github上，使用github集成的Travis CI自动触发CI流程。在CI中自动build新的image上传到Docker Hub。然后通过sshpass远程登录server触发部署脚本。部署脚本pull新的image然后部署。
Dockerfile    由于项目都是基于python的，所以dockerfile比较简单：
FROMubuntu:latestMAINTAINERShaobo Liu <shaobo@mkdef.com>LABEL Description=&#34;This image is used to flask-kraken&#34;RUN apt-get update -yRUN apt-get install -y python3-pip python3-dev build-essentialCOPY src /appCOPY requirements.txt /appWORKDIR/appRUN pip3 install -r requirements.txtENTRYPOINT [&#34;python3&#34;]CMD [&#34;app.py&#34;]分解一下：
FROMubuntu:latestMAINTAINERShaobo Liu <shaobo@mkdef.com>LABEL Description=&#34;This image is used to flask-kraken&#34;首先申明使用的基础镜像，然后写上大名表示我是维护这个镜像的作者和这个镜像的用途。
RUN apt-get update -yRUN apt-get install -y python3-pip python3-dev build-essential安装python3，如果有其他的工具或者lib，也要写在这里。
COPY src /appCOPY requirements.txt /appWORKDIR/appRUN pip3 install -r requirements.txt复制源代码到docker里，然后切换工作目录，安装三方依赖。 有时候这里需要安装一些系统级的依赖，比如lxml或者psycopg2之类的，就需要加到前面apt-get install里去。">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.mkdef.com/posts/%E5%9F%BA%E4%BA%8Etravis%E5%92%8Cdocker%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2017-04-10T18:41:27+08:00">
<meta property="article:modified_time" content="2017-04-10T18:41:27+08:00">
<title>
基于travis和docker的持续集成 · Coder
</title>
<link rel=canonical href=https://blog.mkdef.com/posts/%E5%9F%BA%E4%BA%8Etravis%E5%92%8Cdocker%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/>
<link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin>
<link rel=stylesheet href=/css/coder.min.d9fddbffe6f27e69985dc5fe0471cdb0e57fbf4775714bc3d847accb08f4a1f6.css integrity="sha256-2f3b/+byfmmYXcX+BHHNsOV/v0d1cUvD2Eesywj0ofY=" crossorigin=anonymous media=screen>
<link rel=stylesheet href=/css/coder-dark.min.002ee2378e14c7a68f1f0a53d9694ed252090987c4e768023fac694a4fc5f793.css integrity="sha256-AC7iN44Ux6aPHwpT2WlO0lIJCYfE52gCP6xpSk/F95M=" crossorigin=anonymous media=screen>
<link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16>
<link rel=apple-touch-icon href=/images/apple-touch-icon.png>
<link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png>
<meta name=generator content="Hugo 0.92.0">
</head>
<body class="preload-transitions colorscheme-auto">
<div class=float-container>
<a id=dark-mode-toggle class=colorscheme-toggle>
<i class="fa fa-adjust fa-fw" aria-hidden=true></i>
</a>
</div>
<main class=wrapper>
<nav class=navigation>
<section class=container>
<a class=navigation-title href=/>
Coder
</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle>
<i class="fa fa-bars fa-fw" aria-hidden=true></i>
</label>
<ul class=navigation-list>
<li class=navigation-item>
<a class=navigation-link href=/posts/>Blog</a>
</li>
<li class=navigation-item>
<a class=navigation-link href=/about/>About</a>
</li>
</ul>
</section>
</nav>
<div class=content>
<section class="container post">
<article>
<header>
<div class=post-title>
<h1 class=title>
<a class=title-link href=https://blog.mkdef.com/posts/%E5%9F%BA%E4%BA%8Etravis%E5%92%8Cdocker%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90/>
基于travis和docker的持续集成
</a>
</h1>
</div>
<div class=post-meta>
<div class=date>
<span class=posted-on>
<i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2017-04-10T18:41:27+08:00>
April 10, 2017
</time>
</span>
<span class=reading-time>
<i class="fa fa-clock-o" aria-hidden=true></i>
One-minute read
</span>
</div>
<div class=tags>
<i class="fa fa-tag" aria-hidden=true></i>
<span class=tag>
<a href=/tags/travis/>Travis</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/docker/>Docker</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/github/>Github</a>
</span>
<span class=separator>•</span>
<span class=tag>
<a href=/tags/nginx/>Nginx</a>
</span></div>
</div>
</header>
<div>
<p>本文主要是记录一下最近在两个小项目odes和kraken中使用的持续集成技术。</p>
<h2 id=所使用的基础组件>
所使用的基础组件
<a class=heading-link href=#%e6%89%80%e4%bd%bf%e7%94%a8%e7%9a%84%e5%9f%ba%e7%a1%80%e7%bb%84%e4%bb%b6>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>代码托管在Github上，使用github集成的Travis CI自动触发CI流程。在CI中自动build新的image上传到Docker Hub。然后通过sshpass远程登录server触发部署脚本。部署脚本pull新的image然后部署。</p>
<h2 id=dockerfile>
Dockerfile
<a class=heading-link href=#dockerfile>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>由于项目都是基于python的，所以dockerfile比较简单：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=font-weight:700>FROM</span><span style=font-style:italic> ubuntu:latest</span><span>
</span><span></span><span style=font-weight:700>MAINTAINER</span><span style=font-style:italic> Shaobo Liu &lt;shaobo@mkdef.com&gt;</span><span>
</span><span></span><span style=font-weight:700>LABEL</span> Description=<span style=font-style:italic>&#34;This image is used to flask-kraken&#34;</span><span>
</span><span></span><span style=font-weight:700>RUN</span> apt-get update -y<span>
</span><span></span><span style=font-weight:700>RUN</span> apt-get install -y python3-pip python3-dev build-essential<span>
</span><span></span><span style=font-weight:700>COPY</span> src /app<span>
</span><span></span><span style=font-weight:700>COPY</span> requirements.txt /app<span>
</span><span></span><span style=font-weight:700>WORKDIR</span><span style=font-style:italic> /app</span><span>
</span><span></span><span style=font-weight:700>RUN</span> pip3 install -r requirements.txt<span>
</span><span></span><span style=font-weight:700>ENTRYPOINT</span> [<span style=font-style:italic>&#34;python3&#34;</span>]<span>
</span><span></span><span style=font-weight:700>CMD</span> [<span style=font-style:italic>&#34;app.py&#34;</span>]<span>
</span></code></pre></div><p>分解一下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=font-weight:700>FROM</span><span style=font-style:italic> ubuntu:latest</span><span>
</span><span></span><span style=font-weight:700>MAINTAINER</span><span style=font-style:italic> Shaobo Liu &lt;shaobo@mkdef.com&gt;</span><span>
</span><span></span><span style=font-weight:700>LABEL</span> Description=<span style=font-style:italic>&#34;This image is used to flask-kraken&#34;</span><span>
</span></code></pre></div><p>首先申明使用的基础镜像，然后写上大名表示我是维护这个镜像的作者和这个镜像的用途。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=font-weight:700>RUN</span> apt-get update -y<span>
</span><span></span><span style=font-weight:700>RUN</span> apt-get install -y python3-pip python3-dev build-essential<span>
</span></code></pre></div><p>安装python3，如果有其他的工具或者lib，也要写在这里。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=font-weight:700>COPY</span> src /app<span>
</span><span></span><span style=font-weight:700>COPY</span> requirements.txt /app<span>
</span><span></span><span style=font-weight:700>WORKDIR</span><span style=font-style:italic> /app</span><span>
</span><span></span><span style=font-weight:700>RUN</span> pip3 install -r requirements.txt<span>
</span></code></pre></div><p>复制源代码到docker里，然后切换工作目录，安装三方依赖。 有时候这里需要安装一些系统级的依赖，比如lxml或者psycopg2之类的，就需要加到前面<code>apt-get install</code>里去。</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=font-weight:700>ENTRYPOINT</span> [<span style=font-style:italic>&#34;python3&#34;</span>]<span>
</span><span></span><span style=font-weight:700>CMD</span> [<span style=font-style:italic>&#34;app.py&#34;</span>]<span>
</span></code></pre></div><p>最后是需要执行的命令。根据docker的userguide，一个image最好只干一件事。</p>
<h2 id=travis-ci>
Travis CI
<a class=heading-link href=#travis-ci>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<p>在项目根目录添加<code>.travis.yml</code>来定义CI流程</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=font-weight:700>sudo</span>: required

<span style=font-weight:700>language</span>: python

<span style=font-weight:700>services</span>:
  - docker

<span style=font-weight:700>python</span>:
    - <span style=font-style:italic>&#34;3.5&#34;</span>

<span style=font-weight:700>before_install</span>:
  - sudo apt-get update
  - sudo apt-get install sshpass

<span style=font-weight:700>install</span>: <span style=font-style:italic>&#34;pip install -r requirements.txt&#34;</span>

<span style=font-weight:700>script</span>: 
  - python --version

<span style=font-weight:700>after_success</span>:
  - docker login -u=&#34;$DOCKER_USERNAME&#34; -p=&#34;$DOCKER_PASSWORD&#34;
  - docker build -t shaobol/kraken:$TRAVIS_BRANCH-$TRAVIS_BUILD_ID . 
  - docker push shaobol/kraken:$TRAVIS_BRANCH-$TRAVIS_BUILD_ID;
  - sshpass -p $VPS_PASSWORD ssh -o stricthostkeychecking=no root@45.32.137.234 &#34;sudo /home/saukymo/kraken/deploy.sh $TRAVIS_BRANCH-$TRAVIS_BUILD_ID&#34;
</code></pre></div><p>这里就不一一分解了，具体可以参考Travis的官方文档。</p>
<p>主要介绍一下这个部分和其他部分是怎么联动的。首先Travis和Github是有集成服务的，在<code>Setting -> integrations & services</code>里选择添加Travis就可以了。然后在Travis上就可以设置相应的CI流程了，默认是master有新的commit就会自动触发一次CI。</p>
<p>每次CI结束后的结果可以通过<a href="https://travis-ci.org/saukymo/odes.svg?branch=master">badge</a>查看。</p>
<p>重点在于测试完成后build和push docker image的过程</p>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=font-weight:700>after_success</span>:
  - docker login -u=&#34;$DOCKER_USERNAME&#34; -p=&#34;$DOCKER_PASSWORD&#34;
  - docker build -t shaobol/kraken:$TRAVIS_BRANCH-$TRAVIS_BUILD_ID . 
  - docker push shaobol/kraken:$TRAVIS_BRANCH-$TRAVIS_BUILD_ID;
</code></pre></div><p>敏感信息这里全部通过Travis的Environment Variables。这样可以避免因为公开而泄露。</p>
<p>如果需要将一些敏感信息传递到image里面去，可以通过<code>--build-arg</code>参数传递进去，然后保存为环境变量，参考<a href=https://docs.docker.com/engine/reference/builder/#label>reference</a></p>
<p>最后通过<code>sshpass</code>执行部署脚本，这一步也可以使用<code>ansible</code>代替。</p>
<h2 id=docker-部署脚本>
docker 部署脚本
<a class=heading-link href=#docker-%e9%83%a8%e7%bd%b2%e8%84%9a%e6%9c%ac>
<i class="fa fa-link" aria-hidden=true></i>
</a>
</h2>
<div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span>#!/bin/bash
</span><span></span>
docker pull shaobol/odes:$1

<span style=font-weight:700>if</span> docker ps -a | grep -q odes; <span style=font-weight:700>then</span>
    docker rm -f odes
<span style=font-weight:700>fi</span>

docker run -d --name odes -p 9000:9000 --link postgres:postgres shaobol/odes:$1
</code></pre></div><p>脚本很简单，接收CI传过来的参数(image tag)，pull新的image，然后干掉之前的container，run一个新的。这样就完成了update整个过程。</p>
</div>
<footer>
</footer>
</article>
</section>
</div>
<footer class=footer>
<section class=container>
©
2016 -
2022
无生
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.
</section>
</footer>
</main>
<script src=/js/coder.min.39a51230dce2ac866c049b52573e38bf60666af4bc63c1bdf203b9b2d95b1cd6.js integrity="sha256-OaUSMNzirIZsBJtSVz44v2BmavS8Y8G98gO5stlbHNY="></script>
</body>
</html>